

# 读取body建议放在rewrite_by_lua_block
rewrite_by_lua_block {
    if ngx.req.get_method() == "POST" then
        ngx.req.read_body()
        local data = ngx.req.get_body_data()
        if data then
            ngx.ctx.post_body = data
        end
    end
}

log_by_lua_block {
    if ngx.ctx.post_body then
        ngx.log(ngx.ERR, "POST body: ", ngx.ctx.post_body)
    end
}

body_filter_by_lua_block {
    ngx.log(ngx.ERR, "lua log test")
    local resp_body = ngx.arg[1]

    local encoding = ngx.var.upstream_http_content_encoding
    if encoding == "gzip" then
        local ok, unzipped = pcall(ngx.gunzip, resp_body)
        if ok and unzipped then
            resp_body = unzipped
        else
            ngx.log(ngx.ERR, "gunzip failed: ", unzipped)
        end
    end

    if resp_body then
        ngx.ctx.buffered = (ngx.ctx.buffered or "") .. resp_body
    end
    if ngx.arg[2] then
        local cjson = require "cjson"
        local body = ngx.ctx.buffered
        if body then
            local ok, decoded = pcall(cjson.decode, body)
            if ok and decoded then
                -- pretty 格式化，遇到 userdata 输出 null
                local function pretty_json(obj, indent)
                    indent = indent or ""
                    local next_indent = indent .. "  "
                    if type(obj) == "table" then
                        local is_array = (#obj > 0)
                        local s = is_array and "[\n" or "{\n"
                        local first = true
                        for k, v in pairs(obj) do
                            if not first then s = s .. ",\n" end
                            first = false
                            if not is_array then
                                s = s .. next_indent .. '"' .. tostring(k) .. '": ' .. pretty_json(v, next_indent)
                            else
                                s = s .. next_indent .. pretty_json(v, next_indent)
                            end
                        end
                        s = s .. "\n" .. indent .. (is_array and "]" or "}")
                        return s
                    elseif type(obj) == "string" then
                        return '"' .. obj .. '"'
                    elseif type(obj) == "number" or type(obj) == "boolean" then
                        return tostring(obj)
                    elseif type(obj) == "userdata" then
                        return "null"
                    else
                        return "null"
                    end
                end
                ngx.log(ngx.ERR, "Response body (pretty):\n", pretty_json(decoded))
            else
                ngx.log(ngx.ERR, "Response body: ", body)
            end
        end
    end
}